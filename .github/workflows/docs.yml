name: Documentation

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]

defaults:
  run:
    shell: powershell -ExecutionPolicy Bypass {0}

jobs:
  build:
    runs-on: self-hosted
    environment: WIDOWSVAIL
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup Portable Python
      run: |
        $workDir = $env:GITHUB_WORKSPACE
        $pythonDir = "$workDir\python_bin"
        $zipPath = "$workDir\python.zip"
        $version = "3.11.9"
        $url = "https://www.python.org/ftp/python/$version/python-$version-embed-amd64.zip"
        
        Write-Host "Setting up Portable Python in $pythonDir"
        
        # Create directory
        if (-not (Test-Path $pythonDir)) {
             New-Item -ItemType Directory -Path $pythonDir -Force | Out-Null
        }
        
        # Download
        Write-Host "Downloading Python $version..."
        Invoke-WebRequest -Uri $url -OutFile $zipPath
        
        # Extract
        Write-Host "Extracting..."
        Expand-Archive -Path $zipPath -DestinationPath $pythonDir -Force
        
        # Enable 'site' package support (required for pip)
        $pthFile = "$pythonDir\python311._pth"
        if (Test-Path $pthFile) {
            Write-Host "Enabling site support in $pthFile"
            (Get-Content $pthFile) -replace "#import site", "import site" | Set-Content $pthFile
        }
        
        # Download get-pip.py
        Write-Host "Downloading pip bootstrap..."
        Invoke-WebRequest -Uri "https://bootstrap.pypa.io/get-pip.py" -OutFile "$pythonDir\get-pip.py"
        
        # Install pip
        Write-Host "Installing pip..."
        & "$pythonDir\python.exe" "$pythonDir\get-pip.py" --no-warn-script-location
        
        # Add to GITHUB_PATH
        Write-Host "Adding paths to environment..."
        echo "$pythonDir" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append
        echo "$pythonDir\Scripts" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append
        
        # Verify
        & "$pythonDir\python.exe" --version
    
    - name: Install dependencies
      run: |
        $reqFile = Join-Path $env:GITHUB_WORKSPACE "requirements.txt"
        Write-Host "Looking for requirements at: $reqFile"
        if (Test-Path $reqFile) {
            python -m pip install -r $reqFile
        } else {
            Write-Error "Could not find requirements.txt in $env:GITHUB_WORKSPACE"
            exit 1
        }
    
    - name: Build documentation
      run: |
        $mkdocsFile = Join-Path $env:GITHUB_WORKSPACE "mkdocs.yml"
        python -m mkdocs build -f $mkdocsFile
    
    - name: Deploy to GitHub Pages
      if: github.ref == 'refs/heads/master'
      uses: peaceiris/actions-gh-pages@v3
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_dir: ./site
        destination_dir: magidesk-v1