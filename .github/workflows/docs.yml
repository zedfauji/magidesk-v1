name: Documentation

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]

jobs:
  build:
    runs-on: self-hosted
    environment: WIDOWSVAIL
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Ensure Python 3.11
      run: |
        $pythonVersion = "3.11.9"
        $installerUrl = "https://www.python.org/ftp/python/$pythonVersion/python-$pythonVersion-amd64.exe"
        $installerPath = "$env:TEMP\python-$pythonVersion-amd64.exe"
        
        # Check if Python is already installed and in PATH
        if (Get-Command python -ErrorAction SilentlyContinue) {
            $currentVersion = python --version 2>&1
            Write-Host "Python found: $currentVersion"
            if ($currentVersion -match "3\.11") {
                Write-Host "Python 3.11 is already installed."
                exit 0
            }
        }
        
        Write-Host "Python 3.11 not found. Installing..."
        
        # Download Installer
        Invoke-WebRequest -Uri $installerUrl -OutFile $installerPath
        
        # Install Python silently
        Start-Process -FilePath $installerPath -ArgumentList "/quiet InstallAllUsers=1 PrependPath=1" -Wait
        
        # Refresh Environment Variables
        $env:Path = [System.Environment]::GetEnvironmentVariable("Path","Machine") + ";" + [System.Environment]::GetEnvironmentVariable("Path","User")
        
        # Verify Installation
        if (Get-Command python -ErrorAction SilentlyContinue) {
            python --version
        } else {
            Write-Error "Python installation failed or path not updated."
            exit 1
        }
    
    - name: Install dependencies
      run: |
        pip install -r requirements.txt
      shell: bash
    
    - name: Build documentation
      run: |
        mkdocs build
    
    - name: Deploy to GitHub Pages
      if: github.ref == 'refs/heads/master'
      uses: peaceiris/actions-gh-pages@v3
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_dir: ./site
        destination_dir: magidesk-v1