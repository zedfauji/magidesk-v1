name: Documentation

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]

jobs:
  build:
    runs-on: self-hosted
    environment: WIDOWSVAIL
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Ensure Python
      run: |
        $commonPaths = @(
            "C:\Users\giris\AppData\Local\Programs\Python\Python39\python.exe",
            "$env:LOCALAPPDATA\Programs\Python\Python39\python.exe",
            "C:\Program Files\Python311\python.exe",
            "C:\Program Files\Python312\python.exe",
            "$env:LOCALAPPDATA\Programs\Python\Python311\python.exe",
            "$env:LOCALAPPDATA\Programs\Python\Python312\python.exe",
            "C:\Python311\python.exe",
            "C:\Python312\python.exe"
        )
        
        $pythonFound = $false
        
        # 1. Check PATH first
        if (Get-Command python -ErrorAction SilentlyContinue) {
            $version = python --version 2>&1
            Write-Host "Python found in PATH: $version"
            $pythonFound = $true
        }
        
        # 2. Probe common paths if not in PATH
        if (-not $pythonFound) {
            Write-Host "Python not found in PATH. Probing common locations..."
            foreach ($path in $commonPaths) {
                if (Test-Path $path) {
                    Write-Host "Found Python at: $path"
                    $dir = Split-Path -Parent $path
                    
                    # Add to PATH for future steps
                    echo "$dir" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append
                    echo "$dir\Scripts" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append
                    
                    # Add to current session PATH so we can verify immediately
                    $env:Path = "$dir;$dir\Scripts;$env:Path"
                    $pythonFound = $true
                    break
                }
            }
        }
        
        if ($pythonFound) {
             $finalVersion = python --version 2>&1
             Write-Host "Successfully configured: $finalVersion"
        } else {
             Write-Error "Python 3.9+ could not be found. Please ensure it is installed or added to the Machine PATH."
             exit 1
        }
    
    - name: Install dependencies
      run: |
        pip install -r requirements.txt
      shell: bash
    
    - name: Build documentation
      run: |
        mkdocs build
    
    - name: Deploy to GitHub Pages
      if: github.ref == 'refs/heads/master'
      uses: peaceiris/actions-gh-pages@v3
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_dir: ./site
        destination_dir: magidesk-v1