<UserControl
    x:Class="Magidesk.Presentation.Views.Components.VirtualizedTableCanvas"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    xmlns:vm="using:Magidesk.Presentation.ViewModels"
    xmlns:converters="using:Magidesk.Presentation.Converters"
    xmlns:dto="using:Magidesk.Application.DTOs"
    x:Name="RootControl"
    mc:Ignorable="d"
    d:DesignHeight="400"
    d:DesignWidth="600">

    <UserControl.Resources>
        <converters:TableStatusToBrushConverter x:Key="TableStatusConverter"/>
        <converters:ShapeToCornerRadiusConverter x:Key="ShapeToCornerRadiusConverter"/>
        <converters:TableToSelectionVisibilityConverter x:Key="TableToSelectionVisibilityConverter"/>
        <converters:DateTimeToTimeConverter x:Key="DateTimeToTimeConverter"/>
    </UserControl.Resources>

    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
        </Grid.RowDefinitions>

        <!-- Performance Info Bar -->
        <Border Grid.Row="0" 
                Background="{ThemeResource CardBackgroundFillColorDefaultBrush}"
                BorderBrush="{ThemeResource DividerStrokeColorDefaultBrush}"
                BorderThickness="0,0,0,1"
                Padding="8,4">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="Auto"/>
                    <ColumnDefinition Width="Auto"/>
                </Grid.ColumnDefinitions>
                
                <StackPanel Grid.Column="0" Orientation="Horizontal" Spacing="12">
                    <TextBlock Text="Tables: " Style="{StaticResource CaptionTextBlockStyle}"/>
                    <TextBlock Text="{Binding ViewModel.Tables.Count, ElementName=RootControl}" 
                               Style="{StaticResource BodyTextBlockStyle}"/>
                    <TextBlock Text="Visible: " Style="{StaticResource CaptionTextBlockStyle}" 
                              Margin="16,0,0,0"/>
                    <TextBlock Text="{Binding ViewModel.VisibleTableCount, ElementName=RootControl}" 
                               Style="{StaticResource BodyTextBlockStyle}"/>
                    <TextBlock Text="FPS: " Style="{StaticResource CaptionTextBlockStyle}" 
                              Margin="16,0,0,0"/>
                    <TextBlock Text="{Binding ViewModel.CurrentFPS, ElementName=RootControl}" 
                               Style="{StaticResource BodyTextBlockStyle}"/>
                </StackPanel>
                
                <TextBlock Grid.Column="1" 
                           Text="{Binding ViewModel.LastRenderTime, ElementName=RootControl, Converter={StaticResource DateTimeToTimeConverter}}" 
                           Style="{StaticResource CaptionTextBlockStyle}"
                           Margin="8,0"/>
                
                <ProgressRing Grid.Column="2" 
                              Width="16" Height="16" 
                              IsActive="{Binding ViewModel.IsRendering, ElementName=RootControl}"
                              Margin="8,0,0,0"/>
            </Grid>
        </Border>

        <!-- Virtualized Canvas -->
        <ScrollViewer Grid.Row="1" 
                      x:Name="MainScrollViewer"
                      HorizontalScrollBarVisibility="Auto" 
                      VerticalScrollBarVisibility="Auto"
                      ViewChanged="ScrollViewer_ViewChanged"
                      SizeChanged="ScrollViewer_SizeChanged">
            <Canvas Width="{Binding ViewModel.CanvasWidth, ElementName=RootControl}" 
                   Height="{Binding ViewModel.CanvasHeight, ElementName=RootControl}"
                   Background="{Binding ViewModel.BackgroundColor, ElementName=RootControl}">
                
                <!-- Virtualized ItemsControl -->
                <ItemsControl ItemsSource="{Binding ViewModel.VisibleTables, ElementName=RootControl}">
                    <ItemsControl.ItemsPanel>
                        <ItemsPanelTemplate>
                            <Canvas/>
                        </ItemsPanelTemplate>
                    </ItemsControl.ItemsPanel>

                    <ItemsControl.ItemContainerStyle>
                        <Style TargetType="ContentPresenter">
                            <Setter Property="Canvas.Left" Value="{Binding X}"/>
                            <Setter Property="Canvas.Top" Value="{Binding Y}"/>
                        </Style>
                    </ItemsControl.ItemContainerStyle>

                    <ItemsControl.ItemTemplate>
                        <DataTemplate x:DataType="dto:TableDto">
                            <Grid Width="100" Height="100" 
                                  CanDrag="True"
                                  DragStarting="Table_DragStarting"
                                  Drop="Table_Drop"
                                  Tapped="Table_Tapped"
                                  ManipulationMode="TranslateX,TranslateY"
                                  ManipulationStarted="Table_ManipulationStarted"
                                  ManipulationDelta="Table_ManipulationDelta"
                                  ManipulationCompleted="Table_ManipulationCompleted">
                                <Grid.Background>
                                    <SolidColorBrush Color="Transparent"/>
                                </Grid.Background>
                                
                                <!-- Table Visual -->
                                <Border Background="{Binding Status, Converter={StaticResource TableStatusConverter}}"
                                        CornerRadius="{Binding Shape, Converter={StaticResource ShapeToCornerRadiusConverter}}"
                                        BorderThickness="2"
                                        BorderBrush="Gray">
                                    <StackPanel VerticalAlignment="Center" HorizontalAlignment="Center">
                                        <TextBlock Text="{Binding TableNumber}" 
                                                  FontSize="20" 
                                                  FontWeight="Bold" 
                                                  HorizontalAlignment="Center"/>
                                        <TextBlock Text="{Binding Capacity}" 
                                                  FontSize="12" 
                                                  Foreground="Gray" 
                                                  HorizontalAlignment="Center" 
                                                  Margin="0,4,0,0"/>
                                    </StackPanel>
                                </Border>
                                
                                <!-- Selection Indicator -->
                                <Border BorderBrush="{ThemeResource SystemAccentColor}"
                                       BorderThickness="3"
                                       CornerRadius="{Binding Shape, Converter={StaticResource ShapeToCornerRadiusConverter}}"
                                       Visibility="{Binding Converter={StaticResource TableToSelectionVisibilityConverter}, ElementName=RootControl, Path=ViewModel.SelectedTable}"/>
                                
                                <!-- Performance Indicator -->
                                <Border BorderBrush="LimeGreen"
                                       BorderThickness="1"
                                       CornerRadius="{Binding Shape, Converter={StaticResource ShapeToCornerRadiusConverter}}"
                                       Visibility="{Binding IsVisible, Converter={StaticResource BoolToVisibilityConverter}}"
                                       Opacity="0.3"/>
                            </Grid>
                        </DataTemplate>
                    </ItemsControl.ItemTemplate>
                </ItemsControl>
            </Canvas>
        </ScrollViewer>
    </Grid>
</UserControl>
