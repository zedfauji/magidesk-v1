<Page
    x:Class="Magidesk.Presentation.Views.TableDesignerPage"
    x:Name="RootPage"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    xmlns:vm="using:Magidesk.Presentation.ViewModels"
    xmlns:dto="using:Magidesk.Application.DTOs"
    xmlns:components="using:Magidesk.Presentation.Views.Components"
    xmlns:converters="using:Magidesk.Presentation.Converters"
    mc:Ignorable="d">

    <Page.Resources>
        <converters:TableStatusToBrushConverter x:Key="TableStatusConverter"/>
        <converters:ShapeToCornerRadiusConverter x:Key="ShapeToCornerRadiusConverter"/>
        <converters:EnumToBoolConverter x:Key="EnumToBoolConverter"/>
    </Page.Resources>

    <Grid Background="{ThemeResource ApplicationPageBackgroundThemeBrush}">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
            <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>

        <!-- Header Toolbar -->
        <CommandBar Grid.Row="0" DefaultLabelPosition="Right" Background="Transparent">
            <AppBarToggleButton Icon="Edit" Label="Design Mode" 
                              IsChecked="{x:Bind ViewModel.IsDesignMode, Mode=TwoWay}"
                              Command="{x:Bind ViewModel.ToggleDesignModeCommand}"/>
            <AppBarSeparator/>
            <AppBarButton Icon="Add" Label="Add Table" 
                         Command="{x:Bind ViewModel.AddTableCommand}"
                         IsEnabled="{x:Bind ViewModel.IsDesignMode}"/>
            <AppBarButton Icon="Delete" Label="Delete Table" 
                         Command="{x:Bind ViewModel.DeleteTableCommand}" CommandParameter="{x:Bind ViewModel.SelectedTable}"
                         IsEnabled="{x:Bind ViewModel.IsDesignMode}"/>
            <AppBarSeparator/>
            <AppBarButton Icon="Save" Label="Save Layout" 
                         Command="{x:Bind ViewModel.SaveLayoutCommand}"/>
            <AppBarButton Icon="Refresh" Label="Reload" 
                         Command="{x:Bind ViewModel.LoadLayoutCommand}"/>
        </CommandBar>

        <!-- Main Designer Area -->
        <Grid Grid.Row="1">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="250"/>
                <ColumnDefinition Width="*"/>
            </Grid.ColumnDefinitions>

            <!-- Left Panel - Controls -->
            <ScrollViewer Grid.Column="0" Background="{ThemeResource CardBackgroundFillColorDefaultBrush}">
                <StackPanel Padding="16" Spacing="16">
                    
                    <!-- Layout Info -->
                    <StackPanel Spacing="8">
                        <TextBlock Text="Layout Information" Style="{StaticResource SubtitleTextBlockStyle}"/>
                        <TextBox Header="Layout Name" 
                                Text="{x:Bind ViewModel.LayoutName, Mode=TwoWay}"
                                IsEnabled="{x:Bind ViewModel.IsDesignMode}"/>
                        <ComboBox Header="Floor" 
                                 ItemsSource="{x:Bind ViewModel.Floors, Mode=OneWay}"
                                 SelectedItem="{x:Bind ViewModel.SelectedFloor, Mode=TwoWay}">
                            <ComboBox.ItemTemplate>
                                <DataTemplate x:DataType="dto:FloorDto">
                                    <TextBlock Text="{x:Bind Name}"/>
                                </DataTemplate>
                            </ComboBox.ItemTemplate>
                        </ComboBox>
                    </StackPanel>

                    <!-- Table Shape Selection -->
                    <components:TableShapePalette x:Name="ShapePalette" Margin="0,0,0,16"/>

                    <!-- Instructions -->
                    <StackPanel Spacing="8">
                        <TextBlock Text="Instructions" Style="{StaticResource SubtitleTextBlockStyle}"/>
                        <TextBlock Text="• Click on canvas to add table" 
                                  Style="{StaticResource CaptionTextBlockStyle}"
                                  TextWrapping="Wrap"/>
                        <TextBlock Text="• Drag tables to reposition" 
                                  Style="{StaticResource CaptionTextBlockStyle}"
                                  TextWrapping="Wrap"/>
                        <TextBlock Text="• Select table and press Delete to remove" 
                                  Style="{StaticResource CaptionTextBlockStyle}"
                                  TextWrapping="Wrap"/>
                        <TextBlock Text="• Toggle Design Mode to enable/disable editing" 
                                  Style="{StaticResource CaptionTextBlockStyle}"
                                  TextWrapping="Wrap"/>
                    </StackPanel>

                </StackPanel>
            </ScrollViewer>

            <!-- Design Canvas -->
            <Border Grid.Column="1" 
                    Background="#f8f8f8" 
                    BorderBrush="{ThemeResource DividerStrokeColorDefaultBrush}" 
                    BorderThickness="1"
                    Margin="8">
                <ScrollViewer HorizontalScrollBarVisibility="Auto" 
                              VerticalScrollBarVisibility="Auto"
                              ZoomMode="Disabled">
                    <Grid Width="{x:Bind ViewModel.SelectedFloor.Width, Mode=OneWay, FallbackValue=2000}" 
                         Height="{x:Bind ViewModel.SelectedFloor.Height, Mode=OneWay, FallbackValue=2000}"
                         Background="{x:Bind ViewModel.SelectedFloor.BackgroundColor, Mode=OneWay, FallbackValue=#f8f8f8}">
                        
                        <!-- Click to add table area -->
                        <Grid Tapped="Canvas_Tapped">
                            <ItemsControl ItemsSource="{x:Bind ViewModel.Tables, Mode=OneWay}">
                                <!-- Panel is a Canvas for absolute positioning -->
                                <ItemsControl.ItemsPanel>
                                    <ItemsPanelTemplate>
                                        <Canvas/>
                                    </ItemsPanelTemplate>
                                </ItemsControl.ItemsPanel>

                                <!-- Bind Canvas.Left/Top to X/Y properties -->
                                <ItemsControl.ItemContainerStyle>
                                    <Style TargetType="ContentPresenter">
                                        <Setter Property="Canvas.Left" Value="{Binding X}"/>
                                        <Setter Property="Canvas.Top" Value="{Binding Y}"/>
                                    </Style>
                                </ItemsControl.ItemContainerStyle>

                                <!-- Item Template: The Table Button -->
                                <ItemsControl.ItemTemplate>
                                    <DataTemplate x:DataType="dto:TableDto">
                                        <Grid Width="100" Height="100" 
                                              CanDrag="{Binding ViewModel.IsDesignMode, ElementName=RootPage}"
                                              DragStarting="Table_DragStarting"
                                              Drop="Table_Drop"
                                              Tapped="Table_Tapped"
                                              ManipulationMode="TranslateX,TranslateY"
                                              ManipulationStarted="Table_ManipulationStarted"
                                              ManipulationDelta="Table_ManipulationDelta"
                                              ManipulationCompleted="Table_ManipulationCompleted">
                                            <Grid.Background>
                                                <SolidColorBrush Color="Transparent"/>
                                            </Grid.Background>
                                            
                                            <!-- Table Visual -->
                                            <Border Background="{Binding Status, Converter={StaticResource TableStatusConverter}}"
                                                    CornerRadius="{Binding Shape, Converter={StaticResource ShapeToCornerRadiusConverter}}"
                                                    BorderThickness="2"
                                                    BorderBrush="Gray">
                                                <StackPanel VerticalAlignment="Center" HorizontalAlignment="Center">
                                                    <TextBlock Text="{Binding TableNumber}" 
                                                              FontSize="20" 
                                                              FontWeight="Bold" 
                                                              HorizontalAlignment="Center"/>
                                                    <TextBlock Text="{Binding Capacity}" 
                                                              FontSize="12" 
                                                              Foreground="Gray" 
                                                              HorizontalAlignment="Center" 
                                                              Margin="0,4,0,0"/>
                                                </StackPanel>
                                            </Border>
                                            
                                            <!-- Selection Indicator -->
                                            <Border BorderBrush="{ThemeResource SystemAccentColor}"
                                                   BorderThickness="3"
                                                   CornerRadius="{Binding Shape, Converter={StaticResource ShapeToCornerRadiusConverter}}"
                                                   Visibility="{Binding ViewModel.SelectedTable, ElementName=RootPage, Converter={StaticResource TableToSelectionVisibilityConverter}, ConverterParameter={Binding}, Mode=OneWay}"/>
                                            
                                            <!-- Drag Indicator -->
                                            <Border BorderBrush="{ThemeResource SystemAccentColorLight1}"
                                                   BorderThickness="2"
                                                   CornerRadius="{Binding Shape, Converter={StaticResource ShapeToCornerRadiusConverter}}"
                                                   Background="{ThemeResource SystemAccentColorLight1}"
                                                   Opacity="0.3"
                                                   Visibility="{Binding ViewModel.IsDesignMode, ElementName=RootPage, Converter={StaticResource BoolToVisibilityConverter}}"/>
                                        </Grid>
                                    </DataTemplate>
                                </ItemsControl.ItemTemplate>
                            </ItemsControl>
                        </Grid>
                    </Grid>
                </ScrollViewer>
            </Border>
        </Grid>

        <!-- Status Bar -->
        <Border Grid.Row="2" 
                Background="{ThemeResource CardBackgroundFillColorDefaultBrush}"
                BorderBrush="{ThemeResource DividerStrokeColorDefaultBrush}"
                BorderThickness="0,1,0,0"
                Padding="16,8">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="Auto"/>
                </Grid.ColumnDefinitions>
                
                <StackPanel Orientation="Horizontal" Spacing="16">
                    <TextBlock Text="Tables: " Style="{StaticResource CaptionTextBlockStyle}"/>
                    <TextBlock Text="{x:Bind ViewModel.Tables.Count, Mode=OneWay}" 
                              Style="{StaticResource BodyTextBlockStyle}"/>
                    <TextBlock Text="Mode: " Style="{StaticResource CaptionTextBlockStyle}" Margin="16,0,0,0"/>
                    <TextBlock Text="{x:Bind ViewModel.IsDesignMode, Mode=OneWay, Converter={StaticResource BoolToDesignModeTextConverter}}" 
                              Style="{StaticResource BodyTextBlockStyle}"/>
                </StackPanel>
                
                <ProgressRing Grid.Column="1" 
                              Width="16" Height="16" 
                              IsActive="{x:Bind ViewModel.IsBusy, Mode=OneWay}"
                              Visibility="{x:Bind ViewModel.IsBusy, Mode=OneWay, Converter={StaticResource BoolToVisibilityConverter}}"/>
            </Grid>
        </Border>
    </Grid>
</Page>
