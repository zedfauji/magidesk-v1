<ContentDialog
    x:Class="Magidesk.Views.RefundWizardDialog"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    xmlns:vm="using:Magidesk.Presentation.ViewModels"
    mc:Ignorable="d"
    Title="{Binding StepTitle}"
    PrimaryButtonText="{Binding PrimaryButtonText}"
    SecondaryButtonText="Back"
    CloseButtonText="Cancel"
    IsPrimaryButtonEnabled="{Binding IsNotBusy}"
    PrimaryButtonClick="OnPrimaryButtonClick"
    SecondaryButtonClick="OnSecondaryButtonClick"
    CornerRadius="8">

    <Grid RowSpacing="12" ColumnSpacing="12">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/> 
            <RowDefinition Height="*"/>
            <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>

        <!-- Progress Indicator (Optional) - Removed duplicate title -->

        <!-- ERROR BANNER -->
        <InfoBar Grid.Row="2" 
                 IsOpen="{Binding HasError}"
                 Severity="Error"
                 Message="{Binding ErrorMessage}"
                 IsClosable="False"/>

        <ProgressBar Grid.Row="2" VerticalAlignment="Bottom" IsIndeterminate="True" Visibility="{Binding IsBusy, Converter={StaticResource BoolToVisibilityConverter}}"/>

        <!-- STEP 1: MODE SELECTION -->
        <StackPanel x:Name="Step1Panel" Grid.Row="1" Spacing="16" Visibility="{Binding IsStep1Visible, Converter={StaticResource BoolToVisibilityConverter}}">
            <TextBlock Text="Select Refund Type" FontWeight="SemiBold" Margin="0,0,0,8"/>
            <StackPanel Spacing="8">
                <RadioButton Content="Full Refund (All Payments)" IsChecked="{Binding IsFullMode, Mode=TwoWay}"/>
                <RadioButton Content="Partial Refund" IsChecked="{Binding IsPartialMode, Mode=TwoWay}"/>
                <RadioButton Content="Specific Payment(s)" IsChecked="{Binding IsSpecificMode, Mode=TwoWay}"/>
            </StackPanel>
        </StackPanel>

        <!-- STEP 2: SCOPE -->
        <StackPanel x:Name="Step2Panel" Grid.Row="1" Spacing="16" Visibility="{Binding IsStep2Visible, Converter={StaticResource BoolToVisibilityConverter}}">
            <!-- Partial Input -->
            <StackPanel Visibility="{Binding IsPartialMode, Converter={StaticResource BoolToVisibilityConverter}}" Spacing="8">
                <TextBlock Text="Enter Amount to Refund"/>
                <NumberBox Value="{Binding PartialAmountInput, Mode=TwoWay}" 
                           PlaceholderText="0.00"/>
            </StackPanel>

            <!-- Specific Payments List -->
            <ListView ItemsSource="{Binding SpecificPayments}" 
                      SelectionMode="None" 
                      Visibility="{Binding IsSpecificMode, Converter={StaticResource BoolToVisibilityConverter}}"
                      MaxHeight="300">
                <ListView.ItemTemplate>
                    <DataTemplate>
                        <CheckBox IsChecked="{Binding IsSelected, Mode=TwoWay}" Content="{Binding Description}"/>
                    </DataTemplate>
                </ListView.ItemTemplate>
            </ListView>
        </StackPanel>

        <!-- STEP 3: PREVIEW -->
        <StackPanel x:Name="Step3Panel" Grid.Row="1" Spacing="16" Visibility="{Binding IsStep3Visible, Converter={StaticResource BoolToVisibilityConverter}}">
            <TextBlock Text="Summary of Changes" Style="{StaticResource BodyStrongTextBlockStyle}"/>
            
            <Grid ColumnDefinitions="*,*,*" RowDefinitions="Auto,Auto,Auto">
                <TextBlock Text="Metric" FontWeight="Bold" Grid.Row="0" Grid.Column="0"/>
                <TextBlock Text="Current" FontWeight="Bold" Grid.Row="0" Grid.Column="1"/>
                <TextBlock Text="After Refund" FontWeight="Bold" Grid.Row="0" Grid.Column="2"/>

                <TextBlock Text="Paid Amount" Grid.Row="1" Grid.Column="0"/>
                <TextBlock Text="{Binding Preview.OriginalPaidAmount}" Grid.Row="1" Grid.Column="1"/>
                <TextBlock Text="{Binding Preview.ProjectedPaidAmount}" Grid.Row="1" Grid.Column="2" Foreground="Red"/>
            </Grid>

            <TextBlock Text="Actions needed:" Margin="0,10,0,0"/>
            <ItemsControl ItemsSource="{Binding Preview.ProposedActions}">
                <ItemsControl.ItemTemplate>
                    <DataTemplate>
                        <TextBlock Text="{Binding Description}" Foreground="{ThemeResource SystemFillColorCautionBrush}"/>
                    </DataTemplate>
                </ItemsControl.ItemTemplate>
            </ItemsControl>
        </StackPanel>

        <!-- STEP 4: AUTH -->
        <StackPanel x:Name="Step4Panel" Grid.Row="1" Spacing="16" Visibility="{Binding IsStep4Visible, Converter={StaticResource BoolToVisibilityConverter}}">
            <TextBlock Text="Manager Authorization Required" Style="{ThemeResource BodyStrongTextBlockStyle}" Foreground="Red"/>
            <TextBox Header="Refund Reason" Text="{Binding RefundReason, Mode=TwoWay}" PlaceholderText="Required..."/>
            <PasswordBox Header="Manager PIN" PlaceholderText="Enter PIN" PasswordChanged="OnPasswordChanged"/>
            <!-- Note: Binding PIN is insecure/tricky in MVVM usually. We might need code-behind helper or Behavior. -->
            
            <Button Content="Confirm Refund" Command="{Binding ConfirmRefundCommand}" Style="{StaticResource AccentButtonStyle}" HorizontalAlignment="Stretch"/>
        </StackPanel>

    </Grid>
</ContentDialog>
