<Page
    x:Class="Magidesk.Presentation.Views.TableMapPage"
    x:Name="RootPage"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    xmlns:vm="using:Magidesk.Presentation.ViewModels"
    xmlns:dto="using:Magidesk.Application.DTOs"
    xmlns:views="using:Magidesk.Presentation.Views"
    xmlns:converters="using:Magidesk.Presentation.Converters"
    mc:Ignorable="d">

    <Page.Resources>
        <converters:TableStatusToBrushConverter x:Key="TableStatusConverter"/>
    </Page.Resources>

    <Grid Background="{ThemeResource ApplicationPageBackgroundThemeBrush}">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
        </Grid.RowDefinitions>

        <!-- Header -->
        <CommandBar DefaultLabelPosition="Right" Background="Transparent">
            <AppBarToggleButton Icon="Sync" Label="Real-time" 
                              IsChecked="{x:Bind ViewModel.IsRealTimeEnabled, Mode=TwoWay}"
                              Command="{x:Bind ViewModel.ToggleRealTimeCommand}"/>
            <AppBarSeparator/>
            <AppBarButton Icon="Refresh" Label="Refresh" Command="{x:Bind ViewModel.RefreshTablesCommand}"/>
            <AppBarElementContainer>
                <StackPanel Orientation="Horizontal" Spacing="8" VerticalAlignment="Center" Margin="12,0,0,0">
                    <TextBlock Text="Last Update:" Style="{StaticResource CaptionTextBlockStyle}" VerticalAlignment="Center"/>
                    <TextBlock Text="{x:Bind ViewModel.LastRefresh, Converter={StaticResource DateTimeToTimeConverter}}" 
                              Style="{StaticResource CaptionTextBlockStyle}" 
                              VerticalAlignment="Center"
                              Foreground="{ThemeResource SystemControlForegroundBaseMediumBrush}"/>
                </StackPanel>
            </AppBarElementContainer>
        </CommandBar>

        <!-- Map Area -->
        <ScrollViewer Grid.Row="1" HorizontalScrollBarVisibility="Auto" VerticalScrollBarVisibility="Auto">
            <Grid Width="{x:Bind ViewModel.CanvasWidth, Mode=OneWay}" 
                  Height="{x:Bind ViewModel.CanvasHeight, Mode=OneWay}"
                  Background="{ThemeResource CardBackgroundFillColorDefaultBrush}">
                <ItemsControl ItemsSource="{x:Bind ViewModel.Tables, Mode=OneWay}">
                    <!-- Panel is a Canvas for absolute positioning -->
                    <ItemsControl.ItemsPanel>
                        <ItemsPanelTemplate>
                            <Canvas/>
                        </ItemsPanelTemplate>
                    </ItemsControl.ItemsPanel>

                <!-- Item Template: The Table Button -->
                <ItemsControl.ItemTemplate>
                    <DataTemplate x:DataType="dto:TableDto">
                        <Button Width="{Binding Width}" Height="{Binding Height}" 
                                Command="{Binding ElementName=RootPage, Path=ViewModel.SelectTableCommand}"
                                CommandParameter="{x:Bind}">
                            <Button.RenderTransform>
                                <TranslateTransform X="{x:Bind X}" Y="{x:Bind Y}"/>
                            </Button.RenderTransform>
                            <Button.Template>
                                <ControlTemplate TargetType="Button">
                                    <Grid>
                                        <!-- Visual Representation -->
                                        <Border x:Name="TableShape" 
                                                CornerRadius="{Binding Shape, Converter={StaticResource ShapeToCornerRadiusConverter}}" 
                                                BorderThickness="2"
                                                BorderBrush="Gray"
                                                Background="{Binding Status, Converter={StaticResource TableStatusConverter}}"> 
                                            <StackPanel VerticalAlignment="Center" HorizontalAlignment="Center">
                                                <TextBlock Text="{Binding TableNumber}" FontSize="24" FontWeight="Bold" HorizontalAlignment="Center"/>
                                                <TextBlock Text="{Binding Capacity}" FontSize="12" Foreground="Gray" HorizontalAlignment="Center" Margin="0,4,0,0"/>
                                            </StackPanel>
                                        </Border>
                                    </Grid>
                                </ControlTemplate>
                            </Button.Template>
                        </Button>
                    </DataTemplate>
                </ItemsControl.ItemTemplate>
            </ItemsControl>
        </Grid>
    </ScrollViewer>
    </Grid>
</Page>
