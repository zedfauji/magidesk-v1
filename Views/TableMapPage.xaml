<Page
    x:Class="Magidesk.Presentation.Views.TableMapPage"
    x:Name="RootPage"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    xmlns:vm="using:Magidesk.Presentation.ViewModels"
    xmlns:dto="using:Magidesk.Application.DTOs"
    xmlns:views="using:Magidesk.Presentation.Views"
    xmlns:converters="using:Magidesk.Presentation.Converters"
    mc:Ignorable="d">

    <Page.Resources>
        <converters:TableStatusToBrushConverter x:Key="TableStatusConverter"/>
        <converters:TableDtoToStatusBrushConverter x:Key="TableDtoToStatusBrushConverter"/>
        <converters:TableSessionStatusToIconConverter x:Key="SessionStatusToIconConverter"/>
        <converters:TableStatusToTooltipConverter x:Key="TableStatusToTooltipConverter"/>
        <converters:NullToVisibilityConverter x:Key="NullToVisibilityConverter"/>
    </Page.Resources>

    <Grid Background="{ThemeResource ApplicationPageBackgroundThemeBrush}">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
        </Grid.RowDefinitions>

        <!-- Header -->
        <CommandBar DefaultLabelPosition="Right" Background="Transparent">
            <AppBarToggleButton Icon="Sync" Label="{Binding Localization[TM_RealTime], Mode=OneWay}" 
                              IsChecked="{x:Bind ViewModel.IsRealTimeEnabled, Mode=TwoWay}"
                              Command="{x:Bind ViewModel.ToggleRealTimeCommand}"/>
            <AppBarSeparator/>
            <AppBarButton Icon="Refresh" Label="{Binding Localization[TM_Refresh], Mode=OneWay}" Command="{x:Bind ViewModel.RefreshTablesCommand}"/>
            
            <AppBarElementContainer>
                <StackPanel Orientation="Horizontal" Spacing="8" VerticalAlignment="Center" Margin="12,0,0,0">
                    <TextBlock Text="{Binding Localization[TM_LastUpdate], Mode=OneWay}" Style="{StaticResource CaptionTextBlockStyle}" VerticalAlignment="Center"/>
                    <TextBlock Text="{x:Bind ViewModel.LastRefresh, Converter={StaticResource DateTimeToTimeConverter}}" 
                              Style="{StaticResource CaptionTextBlockStyle}" 
                              VerticalAlignment="Center"
                              Foreground="{ThemeResource SystemControlForegroundBaseMediumBrush}"/>
                </StackPanel>
            </AppBarElementContainer>
        </CommandBar>

        <!-- Map Area -->
        <ScrollViewer Grid.Row="1" HorizontalScrollBarVisibility="Auto" VerticalScrollBarVisibility="Auto">
            <Grid Width="{x:Bind ViewModel.CanvasWidth, Mode=OneWay}" 
                  Height="{x:Bind ViewModel.CanvasHeight, Mode=OneWay}"
                  Background="{ThemeResource CardBackgroundFillColorDefaultBrush}">
                <ItemsControl ItemsSource="{x:Bind ViewModel.Tables, Mode=OneWay}">
                    <!-- Panel is a Canvas for absolute positioning -->
                    <ItemsControl.ItemsPanel>
                        <ItemsPanelTemplate>
                            <Canvas/>
                        </ItemsPanelTemplate>
                    </ItemsControl.ItemsPanel>

                <!-- Item Template: The Table Button -->
                <ItemsControl.ItemTemplate>
                    <DataTemplate x:DataType="dto:TableDto">
                        <Button Width="{Binding Width}" Height="{Binding Height}" 
                                Command="{Binding ElementName=RootPage, Path=ViewModel.SelectTableCommand}"
                                CommandParameter="{x:Bind}">
                            
                            <!-- Context Menu (Right-Click) -->
                            <Button.ContextFlyout>
                                <MenuFlyout>
                                    <MenuFlyoutItem Text="Start Session" 
                                                   Icon="Play"
                                                   Command="{Binding ElementName=RootPage, Path=ViewModel.OpenStartSessionDialogCommand}"
                                                   CommandParameter="{x:Bind}">
                                        <MenuFlyoutItem.KeyboardAccelerators>
                                            <KeyboardAccelerator Key="S" Modifiers="Control"/>
                                        </MenuFlyoutItem.KeyboardAccelerators>
                                    </MenuFlyoutItem>
                                    
                                    <MenuFlyoutItem Text="End Session" 
                                                   Icon="Stop"
                                                   Command="{Binding ElementName=RootPage, Path=ViewModel.OpenEndSessionDialogCommand}"
                                                   CommandParameter="{x:Bind}">
                                        <MenuFlyoutItem.KeyboardAccelerators>
                                            <KeyboardAccelerator Key="E" Modifiers="Control"/>
                                        </MenuFlyoutItem.KeyboardAccelerators>
                                    </MenuFlyoutItem>
                                    
                                    <MenuFlyoutSeparator/>
                                    
                                    <MenuFlyoutItem Text="Pause Session" 
                                                   Icon="Pause"
                                                   Command="{Binding ElementName=RootPage, Path=ViewModel.PauseSessionCommand}"
                                                   CommandParameter="{x:Bind}"/>
                                    
                                    <MenuFlyoutItem Text="Resume Session" 
                                                   Icon="Play"
                                                   Command="{Binding ElementName=RootPage, Path=ViewModel.ResumeSessionCommand}"
                                                   CommandParameter="{x:Bind}"/>

                                    <MenuFlyoutSeparator Visibility="{Binding ElementName=RootPage, Path=ViewModel.CanAdjustTime, Converter={StaticResource BoolToVisibilityConverter}}"/>

                                    <MenuFlyoutItem Text="Adjust Time" 
                                                   Icon="Edit"
                                                   Command="{Binding ElementName=RootPage, Path=ViewModel.PerformTimeAdjustmentCommand}"
                                                   CommandParameter="{x:Bind}"
                                                   Visibility="{Binding ElementName=RootPage, Path=ViewModel.CanAdjustTime, Converter={StaticResource BoolToVisibilityConverter}}"/>
                                </MenuFlyout>
                            </Button.ContextFlyout>
                            
                            <Button.RenderTransform>
                                <TranslateTransform X="{x:Bind X}" Y="{x:Bind Y}"/>
                            </Button.RenderTransform>
                            <Button.Template>
                                <ControlTemplate TargetType="Button">
                                    <Grid>
                                        <!-- Visual Representation -->
                                        <Border x:Name="TableShape" 
                                                CornerRadius="{Binding Shape, Converter={StaticResource ShapeToCornerRadiusConverter}}" 
                                                BorderThickness="2"
                                                BorderBrush="Gray"
                                                Background="{Binding Converter={StaticResource TableDtoToStatusBrushConverter}}">
                                            
                                            <!-- Tooltip with detailed status information -->
                                            <ToolTipService.ToolTip>
                                                <ToolTip Content="{Binding Converter={StaticResource TableStatusToTooltipConverter}}"/>
                                            </ToolTipService.ToolTip>
                                            
                                            <Grid>
                                                <!-- Main Content -->
                                                <StackPanel VerticalAlignment="Center" HorizontalAlignment="Center" Spacing="4">
                                                    <TextBlock Text="{Binding TableNumber}" FontSize="24" FontWeight="Bold" HorizontalAlignment="Center"/>
                                                    <TextBlock Text="{Binding Capacity}" FontSize="12" Foreground="Gray" HorizontalAlignment="Center"/>
                                                    
                                                    <!-- Session Timer (visible when session exists) -->
                                                    <StackPanel Visibility="{Binding SessionId, Converter={StaticResource NullToVisibilityConverter}}" 
                                                               Spacing="2" Margin="0,4,0,0">
                                                        <!-- Elapsed Time -->
                                                        <TextBlock Text="{Binding SessionElapsedTimeDisplay}" 
                                                                  FontSize="16" 
                                                                  FontWeight="SemiBold" 
                                                                  Foreground="DarkGreen" 
                                                                  HorizontalAlignment="Center"/>
                                                        
                                                        <!-- Running Charge -->
                                                        <TextBlock Text="{Binding SessionRunningChargeDisplay}" 
                                                                  FontSize="12" 
                                                                  Foreground="DarkGreen" 
                                                                  HorizontalAlignment="Center"/>
                                                    </StackPanel>
                                                </StackPanel>
                                                
                                                <!-- Status Icon Overlay (top-right corner) -->
                                                <FontIcon Glyph="{Binding SessionStatus, Converter={StaticResource SessionStatusToIconConverter}}"
                                                         HorizontalAlignment="Right" 
                                                         VerticalAlignment="Top"
                                                         Margin="4" 
                                                         FontSize="16" 
                                                         Foreground="White"
                                                         Visibility="{Binding SessionId, Converter={StaticResource NullToVisibilityConverter}}"/>
                                            </Grid>
                                        </Border>
                                    </Grid>
                                </ControlTemplate>
                            </Button.Template>
                        </Button>
                    </DataTemplate>
                </ItemsControl.ItemTemplate>
            </ItemsControl>
        </Grid>
    </ScrollViewer>
    </Grid>
</Page>
