<?xml version="1.0" encoding="utf-8"?>
<ContentDialog
    x:Class="Magidesk.Presentation.Views.DrawerPullReportDialog"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    xmlns:vm="using:Magidesk.Presentation.ViewModels"
    xmlns:converters="using:Magidesk.Presentation.Converters"
    mc:Ignorable="d"
    Title="Drawer Pull Report"
    PrimaryButtonText="Print"
    CloseButtonText="Close"
    PrimaryButtonCommand="{Binding PrintCommand}"
    RequestedTheme="Dark">
    
    <ContentDialog.Resources>
        <converters:StringFormatConverter x:Key="StringFormatConverter"/>
        <converters:NullToVisibilityConverter x:Key="NullToVisibilityConverter"/>
        <converters:CollectionEmptyToVisibilityConverter x:Key="CollectionEmptyToVisibilityConverter"/>
        <x:String x:Key="DateFormat">Opened: {0:g}</x:String>
        <x:String x:Key="CurrencyFormat">{0:C}</x:String>
    </ContentDialog.Resources>

    <ScrollViewer MaxHeight="600">
        <Grid RowSpacing="16" Width="400">
            <Grid.RowDefinitions>
                <RowDefinition Height="Auto"/> <!-- Header Info -->
                <RowDefinition Height="Auto"/> <!-- Sales Summary -->
                <RowDefinition Height="Auto"/> <!-- Cash Accountability -->
                <RowDefinition Height="Auto"/> <!-- Exceptions -->
            </Grid.RowDefinitions>

            <!-- Loading State -->
            <ProgressRing IsActive="{Binding IsLoading}" HorizontalAlignment="Center" Grid.RowSpan="4" Canvas.ZIndex="10"/>

            <!-- Header Info -->
            <StackPanel Grid.Row="0" Spacing="4">
                <TextBlock Text="{Binding Report.OpenedAt, Converter={StaticResource StringFormatConverter}, ConverterParameter={StaticResource DateFormat}}" Style="{StaticResource CaptionTextBlockStyle}" Foreground="{ThemeResource SystemControlForegroundBaseMediumBrush}"/>
                 <!-- User/Terminal info could go here if in DTO -->
            </StackPanel>

            <!-- Sales Summary -->
            <StackPanel Grid.Row="1" Spacing="8" BorderBrush="{ThemeResource SystemControlBackgroundBaseLowBrush}" BorderThickness="0,0,0,1" Padding="0,0,0,16">
                <TextBlock Text="Sales Summary" Style="{StaticResource SubtitleTextBlockStyle}"/>
                
                <Grid ColumnDefinitions="*,Auto">
                    <TextBlock Text="Net Sales"/>
                    <TextBlock Grid.Column="1" Text="{Binding Report.TotalCashReceipts, Converter={StaticResource StringFormatConverter}, ConverterParameter={StaticResource CurrencyFormat}}"/> <!-- Note: DTO naming might imply CashReceipts != NetSales, verifying logic -->
                </Grid>
                 <!-- Added placeholder for Tax/Tips if DTO doesn't allow direct Sales/Tax split yet -->
                 <TextBlock Text="* Sales Tax &amp; Net Sales unavailable in backend query" Foreground="Orange" Style="{StaticResource CaptionTextBlockStyle}"/>
            </StackPanel>

            <!-- Cash Accountability -->
            <StackPanel Grid.Row="2" Spacing="8" BorderBrush="{ThemeResource SystemControlBackgroundBaseLowBrush}" BorderThickness="0,0,0,1" Padding="0,0,0,16">
                <TextBlock Text="Cash Accountability" Style="{StaticResource SubtitleTextBlockStyle}"/>

                <Grid ColumnDefinitions="*,Auto" RowSpacing="4">
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="Auto"/> <!-- Divider -->
                        <RowDefinition Height="Auto"/> <!-- Expected -->
                        <RowDefinition Height="Auto"/> <!-- Actual -->
                        <RowDefinition Height="Auto"/> <!-- Difference -->
                    </Grid.RowDefinitions>

                    <TextBlock Grid.Row="0" Text="Opening Balance"/>
                    <TextBlock Grid.Row="0" Grid.Column="1" Text="{Binding Report.OpeningBalance, Converter={StaticResource StringFormatConverter}, ConverterParameter={StaticResource CurrencyFormat}}"/>

                    <TextBlock Grid.Row="1" Text="Cash Sales (Receipts)"/>
                    <TextBlock Grid.Row="1" Grid.Column="1" Text="{Binding Report.TotalCashReceipts, Converter={StaticResource StringFormatConverter}, ConverterParameter={StaticResource CurrencyFormat}}"/>

                    <TextBlock Grid.Row="2" Text="Cash Deposits/Drops"/>
                    <TextBlock Grid.Row="2" Grid.Column="1" Text="{Binding Report.TotalCashDrops, Converter={StaticResource StringFormatConverter}, ConverterParameter={StaticResource CurrencyFormat}}"/>

                    <TextBlock Grid.Row="3" Text="Tips Paid Out"/>
                    <TextBlock Grid.Row="3" Grid.Column="1" Text="($0.00)" Foreground="{ThemeResource SystemControlForegroundBaseMediumBrush}"/> <!-- Placeholder per MVP -->
                    
                    <TextBlock Grid.Row="4" Text="Payouts"/>
                    <TextBlock Grid.Row="4" Grid.Column="1" Text="{Binding Report.TotalPayouts, Converter={StaticResource StringFormatConverter}, ConverterParameter={StaticResource CurrencyFormat}}"/>
                    
                    <Rectangle Grid.Row="5" Grid.ColumnSpan="2" Height="1" Fill="{ThemeResource SystemControlBackgroundBaseLowBrush}" Margin="0,8"/>

                    <TextBlock Grid.Row="6" Text="Expected in Drawer" FontWeight="SemiBold"/>
                    <TextBlock Grid.Row="6" Grid.Column="1" Text="{Binding Report.ExpectedCash, Converter={StaticResource StringFormatConverter}, ConverterParameter={StaticResource CurrencyFormat}}" FontWeight="SemiBold"/>

                    <TextBlock Grid.Row="7" Text="Actual Amount" Visibility="{Binding Report.ActualCash, Converter={StaticResource NullToVisibilityConverter}}"/>
                    <TextBlock Grid.Row="7" Grid.Column="1" Text="{Binding Report.ActualCash, Converter={StaticResource StringFormatConverter}, ConverterParameter={StaticResource CurrencyFormat}}" Visibility="{Binding Report.ActualCash, Converter={StaticResource NullToVisibilityConverter}}"/>

                    <TextBlock Grid.Row="8" Text="Difference" FontWeight="Bold" Foreground="{ThemeResource SystemFillColorCriticalBrush}"/>
                    <TextBlock Grid.Row="8" Grid.Column="1" Text="{Binding Report.Difference, Converter={StaticResource StringFormatConverter}, ConverterParameter={StaticResource CurrencyFormat}}" FontWeight="Bold" Foreground="{ThemeResource SystemFillColorCriticalBrush}" />
                </Grid>
            </StackPanel>

            <!-- Exceptions List -->
             <StackPanel Grid.Row="3" Spacing="8" Padding="0,16,0,0">
                <TextBlock Text="Exceptions (Voids/Discounts)" Style="{StaticResource SubtitleTextBlockStyle}"/>
                <TextBlock Text="* None recorded" Style="{StaticResource BodyTextBlockStyle}" Visibility="{Binding Report.DrawerBleeds.Count, Converter={StaticResource CollectionEmptyToVisibilityConverter}}"/> 
                <!-- Simple list for MVP -->
            </StackPanel>
        </Grid>
    </ScrollViewer>
</ContentDialog>
