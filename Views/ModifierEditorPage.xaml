<Page
    x:Class="Magidesk.Presentation.Views.ModifierEditorPage"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    xmlns:converters="using:Magidesk.Presentation.Converters"
    mc:Ignorable="d"
    Background="{ThemeResource ApplicationPageBackgroundThemeBrush}">

    <UserControl.Resources>
        <!-- Reusing existing converters if available in App.xaml, otherwise defining local alias not needed if integrated correctly -->
    </UserControl.Resources>

    <Grid Padding="24">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
            <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>

        <!-- Header -->
        <StackPanel Grid.Row="0" Margin="0,0,0,24">
            <TextBlock Text="{x:Bind ViewModel.Title}" Style="{StaticResource TitleTextBlockStyle}"/>
            <TextBlock Text="Manage modifier groups and options." Style="{StaticResource BodyTextBlockStyle}" Opacity="0.6"/>
        </StackPanel>

        <!-- Content -->
        <Grid Grid.Row="1">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="250"/> <!-- Groups -->
                <ColumnDefinition Width="250"/> <!-- Modifiers -->
                <ColumnDefinition Width="*"/>   <!-- Details -->
            </Grid.ColumnDefinitions>

            <!-- Column 1: Groups -->
            <Grid Grid.Column="0" Margin="0,0,12,0" Background="{ThemeResource CardBackgroundFillColorDefaultBrush}" CornerRadius="8" Padding="12">
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="*"/>
                    <RowDefinition Height="Auto"/>
                </Grid.RowDefinitions>
                
                <TextBlock Text="Groups" Style="{StaticResource SubtitleTextBlockStyle}" Margin="0,0,0,12"/>
                
                <ListView Grid.Row="1" ItemsSource="{x:Bind ViewModel.Groups}" SelectedItem="{x:Bind ViewModel.SelectedGroup, Mode=TwoWay}">
                    <ListView.ItemTemplate>
                        <DataTemplate>
                            <TextBlock Text="{Binding Name}" Margin="0,8"/>
                        </DataTemplate>
                    </ListView.ItemTemplate>
                </ListView>
                
                <Button Grid.Row="2" Command="{x:Bind ViewModel.AddGroupCommand}" Content="Add Group" HorizontalAlignment="Stretch" Margin="0,12,0,0"/>
            </Grid>

            <!-- Column 2: Modifiers -->
            <Grid Grid.Column="1" Margin="12,0" Background="{ThemeResource CardBackgroundFillColorDefaultBrush}" CornerRadius="8" Padding="12"
                  Visibility="{x:Bind ViewModel.SelectedGroup, Mode=OneWay, Converter={StaticResource NullToVisibilityConverter}}">
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="*"/>
                    <RowDefinition Height="Auto"/>
                </Grid.RowDefinitions>

                <TextBlock Text="Modifiers" Style="{StaticResource SubtitleTextBlockStyle}" Margin="0,0,0,12"/>

                <ListView Grid.Row="1" ItemsSource="{x:Bind ViewModel.Modifiers}" SelectedItem="{x:Bind ViewModel.SelectedModifier, Mode=TwoWay}">
                    <ListView.ItemTemplate>
                        <DataTemplate>
                            <StackPanel Orientation="Horizontal" Spacing="8">
                                <TextBlock Text="{Binding Name}" />
                                <TextBlock Text="{Binding BasePrice.Amount, Converter={StaticResource StringFormatConverter}, ConverterParameter='{}{0:C}'}" Opacity="0.6"/>
                            </StackPanel>
                        </DataTemplate>
                    </ListView.ItemTemplate>
                </ListView>

                <Button Grid.Row="2" Command="{x:Bind ViewModel.AddModifierCommand}" Content="Add Modifier" HorizontalAlignment="Stretch" Margin="0,12,0,0"/>
            </Grid>

            <!-- Column 3: Edit Details -->
            <Grid Grid.Column="2" Margin="12,0,0,0" Background="{ThemeResource CardBackgroundFillColorDefaultBrush}" CornerRadius="8" Padding="24"
                  Visibility="{x:Bind ViewModel.IsEditing, Mode=OneWay, Converter={StaticResource BoolToVisibilityConverter}}">
                <StackPanel Spacing="16">
                    <TextBlock Text="Edit Details" Style="{StaticResource SubtitleTextBlockStyle}"/>
                    
                    <TextBox Header="Name" Text="{x:Bind ViewModel.EditingName, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"/>

                    <!-- Modifier Specific Fields -->
                    <StackPanel Visibility="{x:Bind ViewModel.SelectedModifier, Mode=OneWay, Converter={StaticResource NullToVisibilityConverter}}" Spacing="16">
                        <TextBox Header="Price" Text="{x:Bind ViewModel.EditingPrice, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"/>
                    </StackPanel>

                    <!-- Group Specific Fields -->
                    <StackPanel Visibility="{x:Bind ViewModel.SelectedModifier, Mode=OneWay, Converter={StaticResource NullToVisibilityConverter}, ConverterParameter=Reverse}" Spacing="16">
                        <ToggleSwitch Header="Required Selection" IsOn="{x:Bind ViewModel.IsGroupRequired, Mode=TwoWay}"/>
                        <ToggleSwitch Header="Allow Multiple Choice" IsOn="{x:Bind ViewModel.GroupMultiSelect, Mode=TwoWay}"/>
                        <TextBox Header="Min Selections" Text="{x:Bind ViewModel.GroupMin, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}" InputScope="Number"/>
                        <TextBox Header="Max Selections" Text="{x:Bind ViewModel.GroupMax, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}" InputScope="Number"/>
                    </StackPanel>

                    <StackPanel Orientation="Horizontal" Spacing="12" Margin="0,24,0,0">
                        <Button Command="{x:Bind ViewModel.SaveCommand}" Content="Save Changes" Style="{StaticResource AccentButtonStyle}"/>
                        <Button Command="{x:Bind ViewModel.DeleteCommand}" Content="Delete" Style="{StaticResource DefaultButtonStyle}"/>
                    </StackPanel>
                </StackPanel>
            </Grid>
        </Grid>

        <!-- Footer -->
        <Border Grid.Row="2" Margin="0,12,0,0">
            <TextBlock Text="{x:Bind ViewModel.StatusMessage, Mode=OneWay}" Style="{StaticResource CaptionTextBlockStyle}"/>
        </Border>
    </Grid>
</Page>
