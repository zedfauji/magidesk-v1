<?xml version="1.0" encoding="utf-8"?>
<Page
    x:Class="Magidesk.Presentation.Views.MenuEditorPage"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    xmlns:converters="using:Magidesk.Presentation.Converters"
    mc:Ignorable="d"
    Background="{ThemeResource ApplicationPageBackgroundThemeBrush}">

    <Grid Padding="24">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
        </Grid.RowDefinitions>

        <TextBlock Text="{x:Bind ViewModel.Title}" Style="{StaticResource TitleTextBlockStyle}" Margin="0,0,0,24"/>

        <!-- Toolbar -->
        <CommandBar DefaultLabelPosition="Right" Grid.Row="1" Background="Transparent" IsOpen="True">
            <AppBarButton Icon="Add" Label="Add Category" Command="{x:Bind ViewModel.AddCategoryCommand}"/>
            <AppBarButton Icon="Add" Label="Add Item" Command="{x:Bind ViewModel.AddItemCommand}"/>
            <AppBarButton Icon="Refresh" Label="Reload" Command="{x:Bind ViewModel.LoadDataCommand}"/>
        </CommandBar>

        <!-- Content -->
        <Grid Grid.Row="2" ColumnSpacing="24">
            <!-- Finder Layout -->
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="220"/> <!-- Categories -->
                <ColumnDefinition Width="220"/> <!-- Groups -->
                <ColumnDefinition Width="220"/> <!-- Items -->
                <ColumnDefinition Width="*"/>   <!-- Detail -->
            </Grid.ColumnDefinitions>

            <!-- 1. Categories -->
            <Grid Grid.Column="0" Margin="0,0,12,0">
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="*"/>
                    <RowDefinition Height="Auto"/>
                </Grid.RowDefinitions>
                
                <TextBlock Text="Categories" Style="{StaticResource SubtitleTextBlockStyle}" Margin="0,0,0,8"/>
                
                <Border Grid.Row="1" BorderBrush="{ThemeResource SystemControlForegroundBaseLowBrush}" BorderThickness="1" CornerRadius="4">
                    <ListView ItemsSource="{x:Bind ViewModel.Categories, Mode=OneWay}" 
                              SelectedItem="{x:Bind ViewModel.SelectedCategory, Mode=TwoWay}">
                        <ListView.ItemTemplate>
                            <DataTemplate>
                                <TextBlock Text="{Binding Name}" Padding="12"/>
                            </DataTemplate>
                        </ListView.ItemTemplate>
                    </ListView>
                </Border>
                
                <Button Grid.Row="2" Content="Add Category" HorizontalAlignment="Stretch" Margin="0,8,0,0" Command="{x:Bind ViewModel.AddCategoryCommand}"/>
            </Grid>

            <!-- 2. Groups -->
            <Grid Grid.Column="1" Margin="0,0,12,0" Visibility="{x:Bind ViewModel.SelectedCategory, Mode=OneWay, Converter={StaticResource NullToVisibilityConverter}}">
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="*"/>
                    <RowDefinition Height="Auto"/>
                </Grid.RowDefinitions>

                <TextBlock Text="Groups" Style="{StaticResource SubtitleTextBlockStyle}" Margin="0,0,0,8"/>

                <Border Grid.Row="1" BorderBrush="{ThemeResource SystemControlForegroundBaseLowBrush}" BorderThickness="1" CornerRadius="4">
                    <ListView ItemsSource="{x:Bind ViewModel.Groups, Mode=OneWay}" 
                              SelectedItem="{x:Bind ViewModel.SelectedGroup, Mode=TwoWay}">
                        <ListView.ItemTemplate>
                            <DataTemplate>
                                <TextBlock Text="{Binding Name}" Padding="12"/>
                            </DataTemplate>
                        </ListView.ItemTemplate>
                    </ListView>
                </Border>

                <Button Grid.Row="2" Content="Add Group" HorizontalAlignment="Stretch" Margin="0,8,0,0" Command="{x:Bind ViewModel.AddGroupCommand}"/>
            </Grid>
            
            <!-- 3. Items -->
            <Grid Grid.Column="2" Margin="0,0,12,0" Visibility="{x:Bind ViewModel.SelectedGroup, Mode=OneWay, Converter={StaticResource NullToVisibilityConverter}}">
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="*"/>
                    <RowDefinition Height="Auto"/>
                </Grid.RowDefinitions>

                <TextBlock Text="Items" Style="{StaticResource SubtitleTextBlockStyle}" Margin="0,0,0,8"/>

                <Border Grid.Row="1" BorderBrush="{ThemeResource SystemControlForegroundBaseLowBrush}" BorderThickness="1" CornerRadius="4">
                    <ListView ItemsSource="{x:Bind ViewModel.Items, Mode=OneWay}" 
                              SelectedItem="{x:Bind ViewModel.SelectedItem, Mode=TwoWay}">
                        <ListView.ItemTemplate>
                            <DataTemplate>
                                <StackPanel Orientation="Horizontal" Spacing="8" Padding="12">
                                    <TextBlock Text="{Binding Name}" />
                                    <TextBlock Text="{Binding Price.Amount, Converter={StaticResource StringFormatConverter}, ConverterParameter='{}{0:C}'}" Foreground="{ThemeResource SystemControlForegroundBaseMediumBrush}"/>
                                </StackPanel>
                            </DataTemplate>
                        </ListView.ItemTemplate>
                    </ListView>
                </Border>

                <Button Grid.Row="2" Content="Add Item" HorizontalAlignment="Stretch" Margin="0,8,0,0" Command="{x:Bind ViewModel.AddItemCommand}"/>
            </Grid>

            <!-- 4. Detail View -->
            <Border Grid.Column="3" Background="{ThemeResource SystemControlBackgroundChromeMediumLowBrush}" CornerRadius="8" Padding="24">
                 <Grid>
                     <!-- Placeholder State -->
                     <StackPanel VerticalAlignment="Center" HorizontalAlignment="Center" Spacing="16" Visibility="{x:Bind ViewModel.IsEditing, Mode=OneWay, Converter={StaticResource BoolToVisibilityConverter}, ConverterParameter=Reverse}">
                         <FontIcon Glyph="&#xE70F;" FontSize="48" Foreground="Gray"/>
                         <TextBlock Text="Select an item to edit" Foreground="Gray" Style="{StaticResource SubtitleTextBlockStyle}"/>
                     </StackPanel>

                     <!-- Edit Form -->
                     <StackPanel Spacing="16" Visibility="{x:Bind ViewModel.IsEditing, Mode=OneWay, Converter={StaticResource BoolToVisibilityConverter}}">
                         <TextBlock Text="{x:Bind ViewModel.StatusMessage, Mode=OneWay}" Style="{StaticResource SubtitleTextBlockStyle}" Foreground="{ThemeResource SystemControlForegroundAccentBrush}"/>
                         
                         <TextBox Header="Name" Text="{x:Bind ViewModel.EditingName, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"/>
                         
                         <!-- Sort Order (Category/Group) -->
                         <TextBox Header="Sort Order" 
                                  InputScope="Number"
                                  Text="{x:Bind ViewModel.EditingSortOrder, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                                  Visibility="{x:Bind ViewModel.SelectedItem, Mode=OneWay, Converter={StaticResource NullToVisibilityConverter}, ConverterParameter=Reverse}"/>
                                  
                         <!-- Price (Item Only) -->
                         <TextBox Header="Price" 
                                  InputScope="Number"
                                  Text="{x:Bind ViewModel.EditingPrice, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                                  Visibility="{x:Bind ViewModel.SelectedItem, Mode=OneWay, Converter={StaticResource NullToVisibilityConverter}}"/>

                         <!-- Printer Routing (All Types) -->
                         <ComboBox Header="Printer Routing" 
                                   ItemsSource="{x:Bind ViewModel.PrinterGroups}" 
                                   SelectedItem="{x:Bind ViewModel.SelectedPrinterGroup, Mode=TwoWay}"
                                   DisplayMemberPath="Name" 
                                   HorizontalAlignment="Stretch"/>

                         <!-- Recipe Section -->
                         <Grid Visibility="{x:Bind ViewModel.SelectedItem, Mode=OneWay, Converter={StaticResource NullToVisibilityConverter}}" Margin="0,16,0,0">
                             <Grid.RowDefinitions>
                                 <RowDefinition Height="Auto"/>
                                 <RowDefinition Height="Auto"/>
                                 <RowDefinition Height="Auto"/>
                             </Grid.RowDefinitions>
                             
                             <TextBlock Text="Recipe (Inventory Links)" Style="{StaticResource BodyStrongTextBlockStyle}" Margin="0,0,0,8"/>
                             
                             <!-- Add New Line -->
                             <Grid Grid.Row="1" ColumnSpacing="8" Margin="0,0,0,12">
                                 <Grid.ColumnDefinitions>
                                     <ColumnDefinition Width="*"/>
                                     <ColumnDefinition Width="80"/>
                                     <ColumnDefinition Width="Auto"/>
                                 </Grid.ColumnDefinitions>
                                 <ComboBox PlaceholderText="Select Ingredient" ItemsSource="{x:Bind ViewModel.InventoryOptions}"
                                           SelectedItem="{x:Bind ViewModel.SelectedInventoryOption, Mode=TwoWay}"
                                           DisplayMemberPath="Name" HorizontalAlignment="Stretch"/>
                                 <TextBox Grid.Column="1" PlaceholderText="Qty" Text="{x:Bind ViewModel.NewRecipeQuantity, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}" InputScope="Number"/>
                                 <Button Grid.Column="2" Content="Add" Command="{x:Bind ViewModel.AddRecipeLineCommand}"/>
                             </Grid>
                             
                             <!-- List -->
                             <ListView Grid.Row="2" ItemsSource="{x:Bind ViewModel.RecipeLines}" SelectedItem="{x:Bind ViewModel.SelectedRecipeLine, Mode=TwoWay}"
                                       Height="150" BorderThickness="1" BorderBrush="{ThemeResource SurfaceStrokeColorDefaultBrush}" CornerRadius="4">
                                 <ListView.ItemTemplate>
                                     <DataTemplate>
                                         <Grid>
                                             <Grid.ColumnDefinitions>
                                                 <ColumnDefinition Width="*"/>
                                                 <ColumnDefinition Width="Auto"/>
                                             </Grid.ColumnDefinitions>
                                             <TextBlock Text="{Binding Name}"/>
                                             <StackPanel Grid.Column="1" Orientation="Horizontal" Spacing="4">
                                                 <TextBlock Text="{Binding Quantity}"/>
                                                 <TextBlock Text="{Binding Unit}" Opacity="0.6"/>
                                             </StackPanel>
                                         </Grid>
                                     </DataTemplate>
                                 </ListView.ItemTemplate>
                             </ListView>
                             <Button Grid.Row="2" VerticalAlignment="Top" HorizontalAlignment="Right" Margin="0,4,8,0" 
                                     Background="Transparent" BorderThickness="0"
                                     Command="{x:Bind ViewModel.RemoveRecipeLineCommand}">
                                 <FontIcon Glyph="&#xE74D;" FontSize="12" Foreground="Red"/>
                             </Button>
                         </Grid>
                         
                         <StackPanel Orientation="Horizontal" Spacing="12" Margin="0,24,0,0">
                             <Button Content="Save Changes" Style="{StaticResource AccentButtonStyle}" Command="{x:Bind ViewModel.SaveCommand}"/>
                             <Button Content="Delete" Command="{x:Bind ViewModel.DeleteCommand}"/>
                         </StackPanel>
                     </StackPanel>
                 </Grid>
            </Border>
        </Grid>
        
        <!-- Busy Indicator -->
        <Grid Grid.RowSpan="3" Background="#80000000" Visibility="{x:Bind ViewModel.IsBusy, Mode=OneWay, Converter={StaticResource BoolToVisibilityConverter}}">
             <ProgressRing IsActive="True" Width="60" Height="60"/>
        </Grid>
    </Grid>
</Page>
